<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¯æ•‘ä¸–ç•Œçš„é«˜ä¸­ç”Ÿâ€”â€”å¦‚æœå½“åˆèƒ½å¤Ÿå¥½å¥½å­¦ç‰©ç†çš„è¯â€¦â€¦</title>
    <style>
        body { font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; background: #0d1117; color: #c9d1d9; display: flex; justify-content: center; padding: 20px; line-height: 1.6; }
        #game-container { max-width: 750px; width: 100%; background: #161b22; padding: 30px; border-radius: 12px; border: 1px solid #30363d; box-shadow: 0 8px 32px rgba(0,0,0,0.5); position: relative; }
        h1 { color: #58a6ff; text-align: center; border-bottom: 1px solid #30363d; padding-bottom: 10px; margin-top: 0; }
        .stats { display: flex; justify-content: space-between; background: #21262d; padding: 12px; border-radius: 6px; margin-bottom: 20px; color: #8b949e; font-size: 0.9em; }
        .content { font-size: 1.1em; margin-bottom: 25px; min-height: 180px; white-space: pre-wrap; }
        .choices { display: flex; flex-direction: column; gap: 12px; }
        button { background: #238636; color: white; border: 1px solid rgba(240,246,252,0.1); padding: 14px; border-radius: 6px; cursor: pointer; font-size: 1em; text-align: left; transition: 0.2s; }
        button:hover:not(:disabled) { background: #2ea043; transform: translateX(5px); }
        button:disabled { background: #30363d; color: #8b949e; cursor: not-allowed; opacity: 0.6; }
        .fail-text { color: #f85149; font-weight: bold; }
        .quiz-box { background: #0d1117; border: 1px dashed #58a6ff; padding: 15px; margin-top: 20px; border-radius: 8px; }
        .intro-box { color: #8b949e; font-style: italic; border-left: 3px solid #58a6ff; padding-left: 15px; margin-bottom: 20px; }
        #item-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1f6feb; color: white; padding: 25px 45px; border-radius: 10px; box-shadow: 0 0 50px rgba(88, 166, 255, 0.6); z-index: 1000; text-align: center; animation: popIn 0.4s ease-out; }
        @keyframes popIn { from { transform: translate(-50%, -50%) scale(0.7); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; }
        .item-glow { font-size: 1.6em; font-weight: bold; color: #f1e05a; display: block; margin: 15px 0; text-shadow: 0 0 10px rgba(241,224,90,0.5); }
    </style>
</head>
<body>

<div id="modal-overlay"></div>
<div id="item-modal">
    <span style="letter-spacing: 2px;">âš¡ è·å¾—æ–°ç‰©å“ âš¡</span>
    <span class="item-glow" id="new-item-name"></span>
    <button onclick="closeModal()" style="background: white; color: #1f6feb; width: 100%; text-align: center; border: none;">åŠ å…¥è£…å¤‡æ </button>
</div>

<div id="game-container">
    <h1>æ‹¯æ•‘ä¸–ç•Œçš„é«˜ä¸­ç”Ÿâ€”â€”å¦‚æœå½“åˆèƒ½å¤Ÿå¥½å¥½å­¦ç‰©ç†çš„è¯â€¦â€¦</h1>
    <div class="stats">
        <span>ğŸ§  è„‘åŠ›: <span id="mp">100</span></span>
        <span>ğŸ’ è£…å¤‡: [<span id="inventory-display">åˆå§‹åŒ–...</span>]</span>
        <span>ğŸ“ è¿›åº¦: <span id="step">1</span>/16</span>
    </div>
    <div id="scene-text" class="content"></div>
    <div id="choice-buttons" class="choices"></div>
</div>

<script>
    let hasCleared = (localStorage.getItem('gameCleared') === 'true');
    let state = { 
        mp: 100, 
        inventory: hasCleared ? ["ç‰©ç†è¯¾æœ¬", "è–„è·ç³–"] : ["ç‰©ç†è¯¾æœ¬"], 
        step: 0,
        romanceLevel: 0 
    };

    const physicsQuiz = [
        { q: "å½“ä¸€ä¸ªç‰©ä½“åšåŒ€é€Ÿåœ†å‘¨è¿åŠ¨æ—¶ï¼Œä¸‹åˆ—å“ªä¸ªç‰©ç†é‡æ˜¯ä¸å˜çš„ï¼Ÿ", a: ["é€Ÿç‡", "é€Ÿåº¦", "åŠ é€Ÿåº¦", "åˆå¤–åŠ›"], correct: 0 },
        { q: "æ ¹æ®ç‰›é¡¿ç¬¬äºŒå®šå¾‹ï¼ŒåŠ›ã€è´¨é‡ã€åŠ é€Ÿåº¦çš„å…³ç³»æ˜¯ï¼Ÿ", a: ["F=m/a", "F=ma", "m=Fa", "a=m/F"], correct: 1 },
        { q: "ä¸€ä¸ªè‹¹æœä»æ ‘ä¸Šè‡ªç”±è½ä¸‹ï¼Œä¸è®¡ç©ºæ°”é˜»åŠ›ï¼Œå®ƒçš„ï¼Ÿ", a: ["åŠ¨èƒ½ä¸å˜", "é‡åŠ›åŠ¿èƒ½å¢åŠ ", "æœºæ¢°èƒ½å®ˆæ’", "é€Ÿåº¦ä¿æŒä¸å˜"], correct: 2 },
        { q: "ä¸‹åˆ—å“ªç§ç°è±¡å±äºå…‰çš„æŠ˜å°„ï¼Ÿ", a: ["æ°´ä¸­çš„å€’å½±", "å°å­”æˆåƒ", "å½©è™¹çš„å½¢æˆ", "é•œå­é‡Œçš„åƒ"], correct: 2 },
        { q: "çƒ­åŠ›å­¦ç¬¬ä¸€å®šå¾‹æè¿°çš„æ˜¯ï¼Ÿ", a: ["èƒ½é‡å®ˆæ’", "ç»å¯¹é›¶åº¦ä¸å¯è¾¾åˆ°", "ç†µå¢åŸç†", "åˆ†å­çƒ­è¿åŠ¨"], correct: 0 },
        { q: "ç”µæµå¼ºåº¦çš„å›½é™…å•ä½æ˜¯ï¼Ÿ", a: ["ä¼ç‰¹", "æ¬§å§†", "å®‰åŸ¹", "ç“¦ç‰¹"], correct: 2 },
        { q: "åœ¨çœŸç©ºä¸­ï¼Œæ‰€æœ‰ç”µç£æ³¢çš„ä»€ä¹ˆç‰©ç†é‡æ˜¯ç›¸åŒçš„ï¼Ÿ", a: ["é¢‘ç‡", "æ³¢é•¿", "æ³¢é€Ÿ", "èƒ½é‡"], correct: 2 },
        { q: "ç¬¬ä¸€ä¸ªé€šè¿‡å®éªŒæµ‹å‡ºä¸‡æœ‰å¼•åŠ›å¸¸é‡çš„ç§‘å­¦å®¶æ˜¯ï¼Ÿ", a: ["ç‰›é¡¿", "å¼€æ™®å‹’", "å¡æ–‡è¿ªè®¸", "ä¼½åˆ©ç•¥"], correct: 2 },
        { q: "åœ¨æè¿°ç®€è°è¿åŠ¨æ—¶ï¼Œä½ç§»æœ€å¤§æ—¶ï¼Ÿ", a: ["é€Ÿåº¦æœ€å¤§", "åŠ é€Ÿåº¦æœ€å¤§", "åŠ¨èƒ½æœ€å¤§", "å›å¤åŠ›æœ€å°"], correct: 1 },
        { q: "ä¸‹åˆ—å…³äºæ‘©æ“¦åŠ›çš„è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼Ÿ", a: ["æ‘©æ“¦åŠ›æ€»æ˜¯é˜»ç¢ç‰©ä½“è¿åŠ¨", "é™æ‘©æ“¦åŠ›ä¸€å®šå¤§äºæ»‘åŠ¨æ‘©æ“¦åŠ›", "æ‘©æ“¦åŠ›æ–¹å‘ä¸€å®šä¸è¿åŠ¨æ–¹å‘ç›¸å", "æ‘©æ“¦åŠ›å¯ä»¥ä½œä¸ºåŠ¨åŠ›"], correct: 3 }
    ];

    const story = {
        0: {
            getText: () => "<div class='intro-box'>ä½ æ˜¯ä¸€åæ™®é€šçš„é«˜ä¸­ç”Ÿï¼Œæ­£ä¸ºç‰©ç†è€ƒè¯•è‹¦æ¼ï¼Œå´æ„å¤–ç©¿è¶Šåˆ°äº†å¼‚ä¸–ç•Œâ€”â€”åŸƒç´¢ä¼¦å¤§é™†ã€‚é‚ªæ¶çš„æ­»çµæ³•å¸ˆè«å¾·é›·è¯•å›¾é€šè¿‡çŒ®ç¥­æ‹¥æœ‰æ‚ é•¿å¯¿å‘½çš„ç²¾çµæ—æ¥å®ç°ä»–è‡ªå·±çš„æ°¸ç”Ÿã€‚ç²¾çµå°‘å¥³è‰¾ç³åŠ¨ç”¨äº†ä¸Šå¤ç¦å¿Œé­”æ³•å°†å¼‚ç•Œå‹‡è€…â€”â€”ä¹Ÿå°±æ˜¯ä½ å¬å”¤æ¥åˆ°è¿™ä¸ªä¸–ç•Œã€‚</div>å¸Œæœ›ä½ èƒ½å¤Ÿé˜»æ­¢è«å¾·é›·ã€‚è¯·æ³¨æ„ï¼Œä½ çš„æ¯æ¬¡é€‰é¡¹éƒ½ä¼šå½±å“è¿™ä¸ªä¸–ç•Œçš„å‘½è¿ã€‚æŒæ¡ç‰©ç†å­¦çš„å¤§è„‘æ˜¯ä½ åœ¨è¿™ä¸ªä¸–ç•Œæœ€çè´µçš„ä¸œè¥¿ã€‚è„‘åŠ›æ¶ˆè€—è¿‡å¤šç»“å±€å°±å¯èƒ½å¤±è´¥ã€‚",
            getChoices: () => [{ text: "å¼€å§‹å†’é™©", next: 1 }]
        },
        1: {
            getText: () => hasCleared ? "ä½ çå¼€çœ¼ï¼Œçœ¼å‰ä»ç„¶æ˜¯ä¸€è„¸ç´§å¼ çš„è‰¾ç³ã€‚ä½†æ˜¯å£è¢‹ä¸­çš„è–„è·ç³–å‘Šè¯‰ä½ ï¼Œè¿™å¹¶éæ˜¯ä½ ç¬¬ä¸€æ¬¡æ¥åˆ°è¿™é‡Œã€‚" : "ä½ çŒ›åœ°çå¼€çœ¼ï¼Œé¢å‰æ˜¯ç´§æ¡é•¿å¼“çš„ç²¾çµå°‘å¥³è‰¾ç³ã€‚ä½ æ‰‹é‡Œæ”¥ç€çš„åªæœ‰ä¸€æœ¬ã€Šé«˜ä¸­ç‰©ç†ã€‹ã€‚",
            getChoices: () => [
                { text: "å°è¯•ä¸è‰¾ç³æ²Ÿé€šã€‚", next: 2, effect: { mp: -5 } },
                { text: "å°†è–„è·ç³–é€ç»™è‰¾ç³ã€‚ä½ ä¸èƒ½ç¡®å®šç²¾çµå°‘å¥³æ˜¯å¦å–œæ¬¢è¿™ç§åˆºæ¿€çš„å‘³é“ã€‚", next: 7, effect: { mp: 20, item: "ç²¾çµçš„å‹è°Š", romance: 1 }, disabled: !hasCleared }
            ]
        },
        2: { 
            getText: () => "è‰¾ç³å‘Šè¯‰ä½ ï¼Œè«å¾·é›·å¾ˆå¿«å°±ä¼šå‘ç°å¼‚ç•Œå‹‡è€…çš„é™ä¸´ã€‚ä½ ä»¬å¿…é¡»èµ¶åœ¨è¢«è«å¾·é›·å‘ç°ä¹‹å‰ï¼Œé˜»æ­¢ä»–çš„è®¡åˆ’ã€‚è¯éŸ³æœªè½ï¼Œä¸€åªæ¯èçŒçŠ¬å‘ä½ ä»¬è¢­æ¥ã€‚ä½ æ³¨æ„åˆ°ä¸Šæ–¹æ–œå¡æ‚¬æŒ‚ç€å·¨çŸ³ã€‚", 
            getChoices: () => [
                { text: "åˆ©ç”¨é‡åŠ›åŠ¿èƒ½ï¼Œæ’¬åŠ¨å·¨çŸ³", next: 3, effect: { mp: -5 } }, 
                { text: "åˆ©ç”¨æƒ¯æ€§ï¼ŒåŠ é€Ÿå†²æ’çŒçŠ¬", next: "fail" }
            ] 
        },
        3: { 
            getText: () => "æ‘†è„±æ¯èçŒçŠ¬åï¼Œä½ ä»¬ç´§æ€¥èµ¶å¾€çŸ®äººçŸ¿é“ï¼Œè¯•å›¾å¯»æ‰¾çŸ®äººæ—çš„å¸®åŠ©ã€‚åœ¨çŸ®äººçŸ¿é“ï¼Œä½ ä»¬é‡åˆ°äº†å®ˆå«æœºç”²çš„é˜»æ‹¦ã€‚", 
            getChoices: () => [
                { text: "é€šè¿‡å¯¼çº¿é€ æˆç”µæ± ç»„çŸ­è·¯", next: 4, effect: { mp: -10, item: "ç£é“çŸ¿" } }, 
                { text: "å°è¯•åˆ©ç”¨æœºç”²æ—‹è½¬çš„ç¦»å¿ƒåŠ›å°†å…¶ç”©å¼€", next: "fail" }
            ] 
        },
        4: { 
            getText: () => "çŸ®äººå·´æ—æƒŠå¹äºä½ ç²¾å·§çš„æŠ€è‰ºä¸çŸ¥è¯†ï¼Œç­”åº”å¸®åŠ©ä½ ä»¬ã€‚ä½†å‰ææ˜¯éœ€è¦ä½ å¸®ä»–è§£å†³å³å°†çˆ†ç‚¸çš„çš„ç†”ç‚‰é—®é¢˜ã€‚", 
            getChoices: () => [
                { text: "è®¾è®¡å†·å‡åˆ†ç¦»å®¤", next: 5, effect: { item: "è’¸æ±½å¤–éª¨éª¼", mp: 10 } }, 
                { text: "åˆ©ç”¨é«˜å‹ç”µæµç¬é—´æ±½åŒ–ç†”ç‚‰å†…çš„å¤šä½™ä»¥å¤ª", next: 5, effect: { mp: -30 } }
            ] 
        },
        5: { 
            getText: () => "è«å¾·é›·ç»ˆäºå‘ç°äº†å¼‚ç•Œå‹‡è€…çš„é™ä¸´ã€‚ä»–æ´¾å‡ºæŠ¥ä¸§é¸Ÿå‰æ¥è¢­å‡»ã€‚çŸ®äººå·´æ—æ„¿æ„ä¸ºä½ ä»¬æä¾›ç‚¸è¯ã€‚", 
            getChoices: () => [
                { text: "èŠ±è´¹ä¸€ç‚¹æ—¶é—´è®¡ç®—æŠ›ç‰©çº¿é¢„åˆ¤æŠ•æ·", next: 6, effect: { mp: -5 } }, 
                { text: "åˆ©ç”¨çˆ†ç‚¸äº§ç”Ÿçš„å†²å‡»æ³¢ï¼Œå°†ç¢çŸ³éœ‡å‘æ•Œé˜µ", next: 6, effect: { mp: -25 } }
            ] 
        },
        6: { 
            getText: () => "å‡»è´¥æŠ¥ä¸§é¸Ÿåï¼Œä½ ä»¬å‘è«å¾·é›·çš„åŸå ¡å‡ºå‘ã€‚é€”ä¸­è¢«è«å¾·é›·è®¾ç½®çš„é­”æ³•é˜µå›°ä½ã€‚", 
            getChoices: () => [
                { text: "è¯•å›¾åˆ¶ä½œä¸€æšæŒ‡å—é’ˆã€éœ€è¦ç£é“çŸ¿ã€‘", next: 8, effect: { mp: -15 }, disabled: !state.inventory.includes("ç£é“çŸ¿") }, 
                { text: "åˆ©ç”¨å¤ªé˜³é«˜åº¦è§’åˆ¤æ–­æ–¹å‘å¹¶å¼ºè¡Œçªç ´", next: 8, effect: { mp: -40 } }
            ] 
        },
        7: { getText: () => "ã€å‰§æƒ…åˆ†æ”¯ã€‘è‰¾ç³æ„å¤–åœ°å–œæ¬¢è¿™ç§åˆºæ¿€ã€‚å¥¹ç²¾ç¥å¤§æŒ¯ï¼Œç›´æ¥å°±è¦å¸¦ç€ä½ å‰å¾€è«å¾·é›·çš„åŸå ¡çªè¢­ã€‚", getChoices: () => [{ text: "ç»§ç»­å‰è¿›", next: 8 }] },
        
        // å¢åŠ å…³å¡1ï¼šçœŸå‡è‰¾ç³ï¼ˆä»…æ„Ÿæƒ…çº¿è§¦å‘ï¼‰
        8: {
            getText: () => {
                if (state.romanceLevel > 0) {
                    return "åœ¨åŸå ¡æš—å½±å¤„ï¼Œä½ ä¸è‰¾ç³èµ°æ•£äº†ã€‚ç‰‡åˆ»åï¼Œä¸¤ä¸ªä¸€æ¨¡ä¸€æ ·çš„è‰¾ç³å‡ºç°åœ¨ä½ é¢å‰ï¼Œå¥¹ä»¬éƒ½å£°ç§°è‡ªå·±æ˜¯çœŸçš„ï¼Œå¹¶å‘ä½ ä¼¸å‡ºæ‰‹å¯»æ±‚ä¿¡ä»»ã€‚";
                }
                return "ä½ ä»¬é¿å¼€äº†å®ˆå«ï¼Œæ‚„ç„¶æ¥è¿‘åŸå ¡å¤§é—¨ã€‚";
            },
            getChoices: () => {
                if (state.romanceLevel > 0) {
                    return [
                        { text: "å›æƒ³èµ·ä¹‹å‰é€’å‡ºè–„è·ç³–æ—¶ï¼ŒçœŸè‰¾ç³çœ¼ä¸­é‚£ç‹¬ç‰¹çš„å¾®å…‰è¿›è¡Œè¾¨åˆ«", next: 10, effect: { mp: -10 } },
                        { text: "å‡­å€Ÿç›´è§‰ï¼Œç‰µèµ·å·¦ä¾§é‚£ä¸ªçœ‹èµ·æ¥æ›´æ¸©æŸ”çš„è‰¾ç³", next: "fail_marionette" }
                    ];
                }
                return [{ text: "ç»§ç»­å‰è¿›", next: 10 }];
            }
        },

        10: { 
            getText: () => "ä½ ä»¬ç»ˆäºæ¥åˆ°è«å¾·é›·çš„åŸå ¡å¤–ï¼ŒåŸå ¡è¢«ä¸€æ¡å‰§æ¯’çš„æŠ¤åŸæ²³æ‹±å«ã€‚", 
            getChoices: () => [
                { text: "åˆ©ç”¨ä¼¯åŠªåˆ©åŸç†åˆ¶ä½œå–·æ°”èˆ¹", next: 11, effect: { mp: -5 } }, 
                { text: "å°è¯•åˆ©ç”¨æ°´çš„è¡¨é¢å¼ åŠ›ç›´æ¥é“ºè®¾æµ®æ¡¥", next: "fail" }
            ] 
        },
        11: { 
            getText: () => "è¿›å…¥åŸå ¡åï¼Œå‘ç°èµ°å»Šå¸ƒæ»¡é›·ç”µé­”æ³•ã€‚æ›´ä»¤ä½ éœ‡æƒŠçš„æ˜¯ï¼Œåœ°ç‰¢é‡Œå›šç¦ç€å¤§é‡è™šå¼±çš„ç²¾çµï¼Œè«å¾·é›·æ­£åœ¨æŠ½å–ä»–ä»¬çš„ç”Ÿå‘½åŠ›ã€‚", 
            getChoices: () => [
                { text: "èŠ±è´¹å¤§é‡è„‘åŠ›è§£æ•‘è¿™äº›ç²¾çµ", next: "rescue_logic" }, 
                { text: "æš‚æ—¶æ”¾å¼ƒè§£æ•‘ï¼Œä¿å­˜è„‘åŠ›ç›´æ”»é­”æ³•é˜µæ ¸å¿ƒ", next: 13, effect: { mp: -5 } }
            ] 
        },

        "rescue_logic": {
            getText: () => "ä½ æ­£åœ¨åˆ©ç”¨ç”µç£æ„Ÿåº”åŸç†è¯•å›¾ç ´è§£åœ°ç‰¢çš„é­”æ³•é”é“¾ã€‚è¿™éœ€è¦æå…¶ç²¾å¯†çš„è®¡ç®—å’Œè„‘åŠ›è¾“å‡ºã€‚",
            getChoices: () => {
                // è„‘åŠ›åˆ¤å®šé€»è¾‘ï¼šè§£æ•‘éœ€è¦40ç‚¹è„‘åŠ›ã€‚å¦‚æœè§£æ•‘åè„‘åŠ›<=0ï¼Œåˆ™åŒå½’äºå°½ã€‚
                if (state.mp - 40 <= 0) {
                    return [{ text: "è„‘åŠ›å³å°†æ¯ç«­...åªèƒ½å¼•çˆ†åŸå ¡åŒå½’äºå°½", next: "end_0", effect: { mp: -40 } }];
                }
                return [{ text: "æˆåŠŸè§£æ•‘ï¼å‰©ä¸‹çš„è„‘åŠ›è¿˜è¶³ä»¥ç»§ç»­å†’é™©", next: 12, effect: { mp: -40 } }];
            }
        },

        12: {
            getText: () => "è§£æ•‘ç²¾çµåï¼Œè«å¾·é›·æ„¤æ€’åœ°æ–½å±•äº†ç»å¯¹é›¶åº¦æ­»çµé­”æ³•ï¼åˆ†å­å‡ ä¹åœæ­¢çƒ­è¿åŠ¨ã€‚",
            getChoices: () => [
                { text: "ä½¿ç”¨å¤–éª¨éª¼è¿‡è½½æ‘©æ“¦ç”Ÿçƒ­ã€éœ€è¦è’¸æ±½å¤–éª¨éª¼ã€‘", next: 13, effect: { mp: -10 }, disabled: !state.inventory.includes("è’¸æ±½å¤–éª¨éª¼") },
                { text: "ã€ç¾ç»Šã€‘åˆåŠ›å…±æŒ¯è‡ªç„¶èƒ½é‡ã€éœ€è¦ç²¾çµçš„å‹è°Šã€‘", next: 13, effect: { mp: -10 }, disabled: state.romanceLevel === 0 }
            ]
        },
        13: { 
            getText: () => "æ‰¾åˆ°äº†æ ¸å¿ƒé­”æ³•é˜µã€‚ä½ å‘ç°é­”æ³•é˜µæ­£åœ¨å…±æŒ¯ã€‚å¦‚æœä½ ä¹‹å‰é€‰æ‹©äº†æ”¾å¼ƒè§£æ•‘ç²¾çµï¼Œè‰¾ç³æ­¤æ—¶çš„è¡¨æƒ…æ˜¾å¾—å¼‚å¸¸æ²‰é‡ã€‚", 
            getChoices: () => [
                { text: "åˆ¶é€ ç›¸æ¶ˆå¹²æ¶‰åŒº", next: 14, effect: { mp: -10 } }, 
                { text: "é€šè¿‡æå‡é¢‘ç‡è§¦å‘å…±æŒ¯è‡ªæ¯", next: "fail" }
            ] 
        },
        14: {
            getText: () => {
                let base = "è«å¾·é›·å€’ä¸‹äº†ã€‚ç©ºé—´æ­£åœ¨åå¡Œã€‚\n";
                // æ‰“è´¥æ–¹å¼æè¿°
                if (state.inventory.includes("è’¸æ±½å¤–éª¨éª¼")) {
                    base += "ä¾é ç€è’¸æ±½å¤–éª¨éª¼æä¾›çš„æœ€ååŠ¨åŠ›ï¼Œä½ æŒ¥å‡ºäº†ä¸€è®°è¶…è¶ŠéŸ³é€Ÿçš„é‡æ‹³ã€‚";
                } else if (state.romanceLevel > 0) {
                    base += "ä½ ä¸è‰¾ç³æ‰‹å¿ƒç›¸æŠµï¼Œçº¯ç²¹çš„è‡ªç„¶èƒ½é‡å°†è«å¾·é›·æ¶ˆèã€‚";
                } else {
                    base += "ä½ åˆ¶é€ å‡ºäº†çŸ­æš‚çš„åç¼©å¥‡ç‚¹ã€‚";
                }
                
                if (state.romanceLevel > 0) return base + "\n<span style='color:#ff79c6;'>è‰¾ç³ç´§ç´§æ¡ä½ä½ çš„æ‰‹ï¼šâ€œè°¢è°¢ä½ ã€‚ä½†æˆ‘çŸ¥é“ï¼Œä½ æ³¨å®šè¦å›åˆ°å±äºçœŸç†çš„ä¸–ç•Œ...â€</span>";
                return base + "\nè‰¾ç³æ„Ÿæ¿€åœ°çœ‹ç€ä½ ï¼šâ€œå‹‡è€…ï¼Œä¸–ç•Œå·²ç»å®‰å…¨ï¼Œä½ æ‰“ç®—ï¼Ÿâ€";
            },
            getChoices: () => {
                // å¦‚æœè·³è¿‡äº†è§£æ•‘ç²¾çµï¼Œåªèƒ½å¯¼å‘ç»“å±€4
                if (state.step === 11) {
                    return [{ text: "å›å½’ç°å®", next: "end_4" }];
                }
                let options = [{ text: "å›å½’ç°å®ï¼šé‡Šæ”¾å¾®å‹æ ¸èšå˜å›å½’", next: "final_choice" }];
                if (state.romanceLevel === 0) options.push({ text: "ç•™åœ¨å¼‚ä¸–ç•Œï¼šä½œä¸ºè‹±é›„æ´»ä¸‹å»", next: "end_stay" });
                return options;
            }
        },
        "final_choice": {
            getText: () => "ç™½å…‰åå™¬äº†ä¸€åˆ‡ï¼Œä½ æ„Ÿè§‰è‡ªå·±åœ¨æ—¶ç©ºä¸­æ¼‚æµ®...",
            getChoices: () => [{ text: "è¿æ¥æœ€ç»ˆå‘½è¿", next: state.romanceLevel > 0 ? "end_romance" : "end_normal" }]
        },

        // ç»“å±€å®šä¹‰
        "end_0": { getText: () => "ã€ç»“å±€0ï¼šä¸€åœºå™©æ¢¦ã€‘ä½ åœ¨å‰§ç—›ä¸­å¤±å»æ„è¯†ï¼Œé†’æ¥å‘ç°è‡ªå·±åœ¨åŒ»é™¢ã€‚å¦ˆå¦ˆå‘Šè¯‰ä½ ï¼Œä½ åœ¨æœŸæœ«ç‰©ç†è€ƒè¯•ä¸­æ™•å€’äº†ã€‚è€å¸ˆä»¬éƒ½å¾ˆæ‹…å¿ƒï¼Œè®©ä½ æš‚æ—¶ä¸ç”¨å‚åŠ æœŸæœ«è€ƒè¯•ï¼Œæå‰æ”¾å‡å›å®¶ã€‚ä½ ä¸çŸ¥é“åŸƒç´¢ä¼¦å¤§é™†çš„ä¸€åˆ‡ç©¶ç«Ÿæ˜¯å¦åªæ˜¯ä¸€åœºæ¢¦ï¼Œä¹Ÿä¸çŸ¥é“è‰¾ç³å’Œå¥¹çš„æ—äººæ˜¯å¦å¾—æ•‘ã€‚", choices: [{ text: "å›åˆ°ç°å®ï¼ˆé‡å¯ï¼‰", next: "restart_total" }] },
        "end_stay": { getText: () => "ã€ç»“å±€1ï¼šå¼‚ç•Œè‹±é›„ã€‘ä½ é€‰æ‹©äº†ç•™ä¸‹ã€‚ä½ ä¸ºè¿™ä¸ªä¸–ç•Œå¸¦æ¥äº†ç‰©ç†çš„åŠ›é‡ã€‚æˆä¸ºäº†æ–°çš„ä¼ è¯´ã€‚", choices: [{ text: "ç•™åœ¨å¼‚ä¸–ç•Œï¼ˆé‡å¯ï¼‰", next: "restart_total" }] },
        "end_normal": { getText: () => "ã€ç»“å±€2ï¼šçœŸç†è§‰é†’ã€‘ä½ å‘ç°è‡ªå·±åªæ˜¯åœ¨ç‰©ç†è¯¾ä¸Šåšäº†ä¸€ä¸ªæ¢¦ã€‚åŒæ ·æ‰“çŒç¡çš„åŒæ¡Œæ‹†å¼€äº†ä¸€åŒ…è–„è·ç³–ï¼Œå¹¶ç»™åŠ›ä½ ä¸€é¢—ã€‚å†°å‡‰åˆºæ¿€çš„å‘³é“è®©ä½ å›å¿†èµ·å’Œè‰¾ç³å†’é™©æ—¶çš„ç§ç§ç»å†ã€‚ä½ å‘ç°è‡ªå·±æ— æ³•æ”¾ä¸‹è‰¾ç³ã€‚ä½ å†³å®šé‡æ–°å›åˆ°åŸƒç´¢ä¼¦å¤§é™†ï¼Œå¯»æ‰¾è‰¾ç³ã€‚", choices: [{ text: "å¼€å¯äºŒå‘¨ç›®", next: "restart_with_candy" }] },
        "end_romance": { getText: () => "ã€ç»“å±€3ï¼šå¼‚ç•Œç¾ç»Šã€‘ç¬¬äºŒæ¬¡æ¥åˆ°è¿™ä¸ªä¸–ç•Œçš„ä½ ç ´åäº†æ—¶ç©ºæ³•åˆ™ã€‚ä½ èƒ½æ„Ÿå—åˆ°è¿™ä¸ªä¸–ç•Œæ­£åœ¨æ’æ–¥ä½ ï¼Œä½ çš„æ„è¯†æ¸æ¸æ¨¡ç³Šï¼Œè‰¾ç³åœ¨ä½ èº«è¾¹å¾’åŠ³åœ°å“­æ³£ã€‚ä½ å†æ¬¡çå¼€çœ¼ï¼Œå‘ç°è‡ªå·±ä»ç„¶åœ¨æ•™å®¤é‡Œï¼Œè¿™æ¬¡ä½ çš„åŒæ¡Œå·²ç»å½»åº•è¶´åœ¨æ¡Œä¸Šå‘¼å‘¼å¤§ç¡ï¼Œæ²¡æœ‰äººç»™ä½ è–„è·ç³–ã€‚", choices: [{ text: "å½»åº•ç»ˆç»“æ—…ç¨‹", next: "restart_total" }] },
        "end_4": { getText: () => "ã€ç»“å±€4ï¼šæ®‹é…·ç°å®ã€‘ä½ å‡»è´¥äº†è«å¾·é›·ï¼Œä½ æƒ³å·²ç»æ‹¯æ•‘äº†ä¸–ç•Œã€‚ä½†è‰¾ç³çš„è„¸ä¸Šå†ä¹Ÿæ²¡æœ‰ç¬‘å®¹ã€‚ä½ å›åˆ°ç°å®ä¸–ç•Œï¼Œå¸Œæœ›é‚£äº›æ®‹é…·çš„ç»å†åªæ˜¯ä¸€åœºå™©æ¢¦ã€‚", choices: [{ text: "å›å½’ç°å®ï¼ˆé‡å¯ï¼‰", next: "restart_total" }] },

        "fail": { getText: () => "ä½ å†’é™©çš„ä¸¾åŠ¨å¤±è´¥äº†ã€‚ä½ æ„Ÿåˆ°ä¸€é˜µç—›ï¼ŒåŸæ¥æ˜¯åŒæ¡ŒæŠŠä½ æé†’ï¼Œç‰©ç†è€å¸ˆæ­£ç‚¹åå«ä½ å›ç­”é—®é¢˜ã€‚", quiz: true },
        "fail_marionette": { getText: () => "ã€å¤±è´¥ã€‘ä½ è¢«å‚€å„¡è‰¾ç³çš„æ¸©æŸ”è¡¨è±¡è›Šæƒ‘ï¼Œè¢«è«å¾·é›·çš„é­”æ³•é˜µå›°æ­»åœ¨åŸå ¡åº•å±‚ã€‚ä½ çŒ›ç„¶æƒŠé†’ï¼Œç‰©ç†å·å­å·²ç»è¢«æ³ªæ°´æµ¸æ¹¿äº†ã€‚", quiz: true }
    };

    function showItemModal(itemName) {
        document.getElementById('new-item-name').innerText = itemName;
        document.getElementById('modal-overlay').style.display = 'block';
        document.getElementById('item-modal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
        document.getElementById('item-modal').style.display = 'none';
    }

    function triggerQuiz(failText) {
        const textEl = document.getElementById('scene-text');
        const btnEl = document.getElementById('choice-buttons');
        const q = physicsQuiz[Math.floor(Math.random() * physicsQuiz.length)];
        textEl.innerHTML = `<span class='fail-text'>${failText}</span><br><div class='quiz-box'><b>âš ï¸ çœŸç†è€ƒéªŒï¼š</b><br>${q.q}</div>`;
        btnEl.innerHTML = '';
        q.a.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.innerText = `${String.fromCharCode(65 + i)}. ${opt}`;
            btn.onclick = () => {
                if (i === q.correct) {
                    alert("å›ç­”æ­£ç¡®ï¼ä½ æŒæ¡äº†çœŸç†ï¼Œè·å¾—äº†è–„è·ç³–å¥–åŠ±ã€‚");
                    localStorage.setItem('gameCleared', 'true');
                    location.reload();
                } else {
                    alert("å›ç­”é”™è¯¯ã€‚ä½ é‡æ–°å å…¥å¹³åº¸çš„ç°å®ã€‚");
                    localStorage.setItem('gameCleared', 'false');
                    location.reload();
                }
            };
            btnEl.appendChild(btn);
        });
    }

    function updateStats() {
        document.getElementById('mp').innerText = state.mp;
        document.getElementById('inventory-display').innerText = state.inventory.join(", ");
        document.getElementById('step').innerText = state.step;
    }

    function renderScene(key) {
        if (key === "restart_with_candy") { localStorage.setItem('gameCleared', 'true'); location.reload(); return; }
        if (key === "restart_total") { localStorage.removeItem('gameCleared'); location.reload(); return; }

        const scene = story[key];
        const textEl = document.getElementById('scene-text');
        const btnEl = document.getElementById('choice-buttons');
        
        if (scene.quiz) { triggerQuiz(scene.getText()); return; }

        textEl.innerHTML = (typeof scene.getText === 'function') ? scene.getText() : scene.getText;
        btnEl.innerHTML = '';

        if (state.mp <= 0 && key !== "end_0") { triggerQuiz("è„‘åŠ›è€—å°½ã€‚"); return; }

        const choices = (typeof scene.getChoices === 'function') ? scene.getChoices() : (scene.choices || []);
        choices.forEach(c => {
            const btn = document.createElement('button');
            btn.innerText = c.text;
            if (c.disabled) btn.disabled = true;
            btn.onclick = () => {
                // è®°å½•å½“å‰æ­¥æ•°ä»¥ä¾¿åˆ¤å®šç»“å±€åˆ†æ”¯
                const currentStep = state.step;
                if (c.effect) {
                    if (c.effect.mp) state.mp += c.effect.mp;
                    if (c.effect.romance) state.romanceLevel = c.effect.romance;
                    if (c.effect.item && !state.inventory.includes(c.effect.item)) {
                        state.inventory.push(c.effect.item);
                        showItemModal(c.effect.item);
                    }
                }
                // æ›´æ–°æ˜¾ç¤ºæ­¥æ•°ï¼Œç»“å±€åˆ†æ”¯ä¸­éœ€è¦è®°å½•è·¯å¾„
                if (typeof c.next === 'number') state.step = c.next;
                else if (key === 11 && c.next === 13) state.step = 11; // æ ‡è®°é€‰æ‹©äº†æ”¾å¼ƒç²¾çµ
                
                updateStats();
                renderScene(c.next);
            };
            btnEl.appendChild(btn);
        });
    }

    updateStats();
    renderScene(0);
</script>
</body>
</html>
