<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¯æ•‘ä¸–ç•Œçš„é«˜ä¸­ç”Ÿâ€”â€”å¦‚æœå½“åˆèƒ½å¤Ÿå¥½å¥½å­¦ç‰©ç†çš„è¯â€¦â€¦</title>
    <style>
        body { font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; background: #0d1117; color: #c9d1d9; display: flex; justify-content: center; padding: 20px; line-height: 1.6; }
        #game-container { max-width: 750px; width: 100%; background: #161b22; padding: 30px; border-radius: 12px; border: 1px solid #30363d; box-shadow: 0 8px 32px rgba(0,0,0,0.5); position: relative; }
        h1 { color: #58a6ff; text-align: center; border-bottom: 1px solid #30363d; padding-bottom: 10px; margin-top: 0; }
        .stats { display: flex; justify-content: space-between; background: #21262d; padding: 12px; border-radius: 6px; margin-bottom: 20px; color: #8b949e; font-size: 0.9em; }
        .content { font-size: 1.1em; margin-bottom: 25px; min-height: 180px; white-space: pre-wrap; }
        .choices { display: flex; flex-direction: column; gap: 12px; }
        button { background: #238636; color: white; border: 1px solid rgba(240,246,252,0.1); padding: 14px; border-radius: 6px; cursor: pointer; font-size: 1em; text-align: left; transition: 0.2s; }
        button:hover:not(:disabled) { background: #2ea043; transform: translateX(5px); }
        button:disabled { background: #30363d; color: #8b949e; cursor: not-allowed; opacity: 0.6; }
        .fail-text { color: #f85149; font-weight: bold; }
        .quiz-box { background: #0d1117; border: 1px dashed #58a6ff; padding: 15px; margin-top: 20px; border-radius: 8px; }
        .intro-box { color: #8b949e; font-style: italic; border-left: 3px solid #58a6ff; padding-left: 15px; margin-bottom: 20px; }
        
        /* ç‰©å“è·å¾—å¼¹çª—æ ·å¼ */
        #item-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1f6feb; color: white; padding: 25px 45px; border-radius: 10px; box-shadow: 0 0 50px rgba(88, 166, 255, 0.6); z-index: 1000; text-align: center; animation: popIn 0.4s ease-out; }
        @keyframes popIn { from { transform: translate(-50%, -50%) scale(0.7); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; }
        .item-glow { font-size: 1.6em; font-weight: bold; color: #f1e05a; display: block; margin: 15px 0; text-shadow: 0 0 10px rgba(241,224,90,0.5); }
    </style>
</head>
<body>

<div id="modal-overlay"></div>
<div id="item-modal">
    <span style="letter-spacing: 2px;">âš¡ è·å¾—æ–°ç‰©å“ âš¡</span>
    <span class="item-glow" id="new-item-name"></span>
    <button onclick="closeModal()" style="background: white; color: #1f6feb; width: 100%; text-align: center; border: none;">åŠ å…¥è£…å¤‡æ </button>
</div>

<div id="game-container">
    <h1>æ‹¯æ•‘ä¸–ç•Œçš„é«˜ä¸­ç”Ÿâ€”â€”å¦‚æœå½“åˆèƒ½å¤Ÿå¥½å¥½å­¦ç‰©ç†çš„è¯â€¦â€¦</h1>
    <div class="stats">
        <span>ğŸ§  è„‘åŠ›: <span id="mp">100</span></span>
        <span>ğŸ’ è£…å¤‡: [<span id="inventory-display">åˆå§‹åŒ–...</span>]</span>
        <span>ğŸ“ è¿›åº¦: <span id="step">1</span>/14</span>
    </div>
    <div id="scene-text" class="content"></div>
    <div id="choice-buttons" class="choices"></div>
</div>

<script>
    let hasCleared = localStorage.getItem('gameCleared') === 'true';
    let state = { 
        mp: 100, 
        inventory: hasCleared ? ["ç‰©ç†è¯¾æœ¬", "è–„è·ç³–"] : ["ç‰©ç†è¯¾æœ¬"], 
        step: 0,
        romanceLevel: 0 
    };

    const physicsQuiz = [
        { q: "å½“ä¸€ä¸ªç‰©ä½“åšåŒ€é€Ÿåœ†å‘¨è¿åŠ¨æ—¶ï¼Œä¸‹åˆ—å“ªä¸ªç‰©ç†é‡æ˜¯ä¸å˜çš„ï¼Ÿ", a: ["é€Ÿç‡", "é€Ÿåº¦", "åŠ é€Ÿåº¦", "åˆå¤–åŠ›"], correct: 0 },
        { q: "æ ¹æ®ç‰›é¡¿ç¬¬äºŒå®šå¾‹ï¼ŒåŠ›ã€è´¨é‡ã€åŠ é€Ÿåº¦çš„å…³ç³»æ˜¯ï¼Ÿ", a: ["F=m/a", "F=ma", "m=Fa", "a=m/F"], correct: 1 },
        { q: "ä¸€ä¸ªè‹¹æœä»æ ‘ä¸Šè‡ªç”±è½ä¸‹ï¼Œä¸è®¡ç©ºæ°”é˜»åŠ›ï¼Œå®ƒçš„ï¼Ÿ", a: ["åŠ¨èƒ½ä¸å˜", "é‡åŠ›åŠ¿èƒ½å¢åŠ ", "æœºæ¢°èƒ½å®ˆæ’", "é€Ÿåº¦ä¿æŒä¸å˜"], correct: 2 },
        { q: "ä¸‹åˆ—å“ªç§ç°è±¡å±äºå…‰çš„æŠ˜å°„ï¼Ÿ", a: ["æ°´ä¸­çš„å€’å½±", "å°å­”æˆåƒ", "å½©è™¹çš„å½¢æˆ", "é•œå­é‡Œçš„åƒ"], correct: 2 },
        { q: "çƒ­åŠ›å­¦ç¬¬ä¸€å®šå¾‹æè¿°çš„æ˜¯ï¼Ÿ", a: ["èƒ½é‡å®ˆæ’", "ç»å¯¹é›¶åº¦ä¸å¯è¾¾åˆ°", "ç†µå¢åŸç†", "åˆ†å­çƒ­è¿åŠ¨"], correct: 0 },
        { q: "ç”µæµå¼ºåº¦çš„å›½é™…å•ä½æ˜¯ï¼Ÿ", a: ["ä¼ç‰¹", "æ¬§å§†", "å®‰åŸ¹", "ç“¦ç‰¹"], correct: 2 },
        { q: "åœ¨çœŸç©ºä¸­ï¼Œæ‰€æœ‰ç”µç£æ³¢çš„ä»€ä¹ˆç‰©ç†é‡æ˜¯ç›¸åŒçš„ï¼Ÿ", a: ["é¢‘ç‡", "æ³¢é•¿", "æ³¢é€Ÿ", "èƒ½é‡"], correct: 2 },
        { q: "ç¬¬ä¸€ä¸ªé€šè¿‡å®éªŒæµ‹å‡ºä¸‡æœ‰å¼•åŠ›å¸¸é‡çš„ç§‘å­¦å®¶æ˜¯ï¼Ÿ", a: ["ç‰›é¡¿", "å¼€æ™®å‹’", "å¡æ–‡è¿ªè®¸", "ä¼½åˆ©ç•¥"], correct: 2 },
        { q: "åœ¨æè¿°ç®€è°è¿åŠ¨æ—¶ï¼Œä½ç§»æœ€å¤§æ—¶ï¼Ÿ", a: ["é€Ÿåº¦æœ€å¤§", "åŠ é€Ÿåº¦æœ€å¤§", "åŠ¨èƒ½æœ€å¤§", "å›å¤åŠ›æœ€å°"], correct: 1 },
        { q: "ä¸‹åˆ—å…³äºæ‘©æ“¦åŠ›çš„è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼Ÿ", a: ["æ‘©æ“¦åŠ›æ€»æ˜¯é˜»ç¢ç‰©ä½“è¿åŠ¨", "é™æ‘©æ“¦åŠ›ä¸€å®šå¤§äºæ»‘åŠ¨æ‘©æ“¦åŠ›", "æ‘©æ“¦åŠ›æ–¹å‘ä¸€å®šä¸è¿åŠ¨æ–¹å‘ç›¸å", "æ‘©æ“¦åŠ›å¯ä»¥ä½œä¸ºåŠ¨åŠ›"], correct: 3 }
    ];

    const story = {
        0: {
            getText: () => "<div class='intro-box'>ä½ æ˜¯ä¸€åæ™®é€šçš„é«˜ä¸­ç”Ÿï¼Œæ­£ä¸ºç‰©ç†è€ƒè¯•è‹¦æ¼ï¼Œå´æ„å¤–ç©¿è¶Šåˆ°äº†å¼‚ä¸–ç•Œâ€”â€”åŸƒç´¢ä¼¦å¤§é™†ã€‚é‚ªæ¶çš„æ­»çµæ³•å¸ˆè«å¾·é›·è¯•å›¾é€šè¿‡çŒ®ç¥­æ‹¥æœ‰æ‚ é•¿å¯¿å‘½çš„ç²¾çµæ—æ¥å®ç°ä»–è‡ªå·±çš„æ°¸ç”Ÿã€‚ç²¾çµå°‘å¥³è‰¾ç³åŠ¨ç”¨äº†ä¸Šå¤ç¦å¿Œé­”æ³•å°†å¼‚ç•Œå‹‡è€…â€”â€”ä¹Ÿå°±æ˜¯ä½ å¬å”¤æ¥åˆ°è¿™ä¸ªä¸–ç•Œã€‚</div>å¸Œæœ›ä½ èƒ½å¤Ÿé˜»æ­¢è«å¾·é›·ã€‚è¯·æ³¨æ„ï¼Œä½ çš„æ¯æ¬¡é€‰é¡¹éƒ½ä¼šå½±å“è¿™ä¸ªä¸–ç•Œçš„å‘½è¿ã€‚æŒæ¡ç‰©ç†å­¦çš„å¤§è„‘æ˜¯ä½ åœ¨è¿™ä¸ªä¸–ç•Œæœ€çè´µçš„ä¸œè¥¿ã€‚è„‘åŠ›æ¶ˆè€—è¿‡å¤šç»“å±€å°±å¯èƒ½å¤±è´¥ã€‚",
            getChoices: () => [{ text: "å¼€å§‹å†’é™©", next: 1 }]
        },
        1: {
            getText: () => hasCleared ? "ä½ çå¼€çœ¼ï¼Œçœ¼å‰ä»ç„¶æ˜¯ä¸€è„¸ç´§å¼ çš„è‰¾ç³ã€‚ä½†æ˜¯å£è¢‹ä¸­çš„è–„è·ç³–å‘Šè¯‰ä½ ï¼Œè¿™å¹¶éæ˜¯ä½ ç¬¬ä¸€æ¬¡æ¥åˆ°è¿™é‡Œã€‚" : "ä½ çŒ›åœ°çå¼€çœ¼ï¼Œé¢å‰æ˜¯ç´§æ¡é•¿å¼“çš„ç²¾çµå°‘å¥³è‰¾ç³ã€‚ä½ æ‰‹é‡Œæ”¥ç€çš„åªæœ‰ä¸€æœ¬ã€Šé«˜ä¸­ç‰©ç†ã€‹ã€‚",
            getChoices: () => [
                { text: "å°è¯•ä¸è‰¾ç³æ²Ÿé€šã€‚", next: 2, effect: { mp: -5 } },
                { text: "å°†è–„è·ç³–é€ç»™è‰¾ç³ã€‚ä½ ä¸èƒ½ç¡®å®šç²¾çµå°‘å¥³æ˜¯å¦å–œæ¬¢è¿™ç§åˆºæ¿€çš„å‘³é“ã€‚", next: 7, effect: { mp: 20, item: "ç²¾çµçš„å‹è°Š", romance: 1 }, disabled: !hasCleared }
            ]
        },
        2: { getText: () => "è‰¾ç³å‘Šè¯‰ä½ ï¼Œè«å¾·é›·å¾ˆå¿«å°±ä¼šå‘ç°å¼‚ç•Œå‹‡è€…çš„é™ä¸´ã€‚ä½ ä»¬å¿…é¡»èµ¶åœ¨è¢«è«å¾·é›·å‘ç°ä¹‹å‰ï¼Œé˜»æ­¢ä»–çš„è®¡åˆ’ã€‚è¯éŸ³æœªè½ï¼Œä¸€åªæ¯èçŒçŠ¬å‘ä½ ä»¬è¢­æ¥ã€‚ä½ æ³¨æ„åˆ°ä¸Šæ–¹æ–œå¡æ‚¬æŒ‚ç€å·¨çŸ³ã€‚", getChoices: () => [{ text: "åˆ©ç”¨é‡åŠ›åŠ¿èƒ½ï¼Œæ’¬åŠ¨å·¨çŸ³ã€æ¶ˆè€—è„‘åŠ›ã€‘", next: 3, effect: { mp: -5 } }, { text: "ç­‰å¾…è‰¾ç³å‡ºæ‰‹", next: "fail" }] },
        3: { getText: () => "æ‘†è„±æ¯èçŒçŠ¬åï¼Œä½ ä»¬ç´§æ€¥èµ¶å¾€çŸ®äººçŸ¿é“ï¼Œè¯•å›¾å¯»æ‰¾çŸ®äººæ—çš„å¸®åŠ©ã€‚åœ¨çŸ®äººçŸ¿é“ï¼Œä½ ä»¬é‡åˆ°äº†å®ˆå«æœºç”²çš„é˜»æ‹¦ã€‚", getChoices: () => [{ text: "é€šè¿‡å¯¼çº¿é€ æˆç”µæ± ç»„çŸ­è·¯ã€æ¶ˆè€—è„‘åŠ›ã€‘", next: 4, effect: { mp: -10, item: "ç£é“çŸ¿" } }, { text: "è¯·æ±‚è‰¾ç³ç”¨é­”æ³•æ‘§æ¯å®ˆå«æœºç”²", next: "fail" }] },
        4: { getText: () => "çŸ®äººå·´æ—æƒŠå¹äºä½ ç²¾å·§çš„æŠ€è‰ºä¸çŸ¥è¯†ï¼Œç­”åº”å¸®åŠ©ä½ ä»¬ã€‚ä½†å‰ææ˜¯éœ€è¦ä½ å¸®ä»–è§£å†³å³å°†çˆ†ç‚¸çš„çš„ç†”ç‚‰é—®é¢˜ã€‚", getChoices: () => [{ text: "è®¾è®¡å†·å‡åˆ†ç¦»å®¤ã€æ¶ˆè€—è„‘åŠ›ã€‘", next: 5, effect: { item: "è’¸æ±½å¤–éª¨éª¼", mp: 10 } }, { text: "å°è¯•æ—‹ç´§ä¿é™©é˜€", next: "fail" }] },
        5: { getText: () => "è«å¾·é›·ç»ˆäºå‘ç°äº†å¼‚ç•Œå‹‡è€…çš„é™ä¸´ã€‚ä»–æ´¾å‡ºæ‰€æŠ¥ä¸§é¸Ÿå‰æ¥è¢­å‡»ã€‚çŸ®äººå·´æ—æ„¿æ„ä¸ºä½ ä»¬æä¾›ç‚¸è¯ã€‚", getChoices: () => [{ text: "èŠ±è´¹ä¸€ç‚¹æ—¶é—´è®¡ç®—æŠ›ç‰©çº¿é¢„åˆ¤æŠ•æ·ã€æ¶ˆè€—è„‘åŠ›ã€‘", next: 6, effect: { mp: -5 } }, { text: "å¯»æ‰¾åˆ¶é«˜ç‚¹ç›´å‡»æŠ¥ä¸§é¸Ÿå¤´éƒ¨", next: "fail" }] },
        6: { getText: () => "å‡»è´¥æŠ¥ä¸§é¸Ÿåï¼Œä½ ä»¬å‘è«å¾·é›·çš„åŸå ¡å‡ºå‘ã€‚é€”ä¸­è¢«è«å¾·é›·è®¾ç½®çš„é­”æ³•é˜µå›°ä½ã€‚", getChoices: () => [{ text: "è¯•å›¾åˆ¶ä½œä¸€æšæŒ‡å—é’ˆã€æ¶ˆè€—è„‘åŠ›ã€‘", next: 10, effect: { mp: -15 } }, { text: "è¯·æ±‚è‰¾ç³æ–½å±•é­”æ³•", next: "fail" }] },
        7: { getText: () => "ã€å‰§æƒ…åˆ†æ”¯ã€‘è‰¾ç³æ„å¤–åœ°å–œæ¬¢è¿™ç§åˆºæ¿€ã€‚å¥¹ç²¾ç¥å¤§æŒ¯ï¼Œç›´æ¥å°±è¦å¸¦ç€ä½ å‰å¾€è«å¾·é›·çš„åŸå ¡çªè¢­ã€‚", getChoices: () => [{ text: "ç»§ç»­å‰è¿›", next: 10 }] },
        10: { getText: () => "ä½ ä»¬ç»ˆäºæ¥åˆ°è«å¾·é›·çš„åŸå ¡å¤–ï¼ŒåŸå ¡è¢«ä¸€æ¡å‰§æ¯’çš„æŠ¤åŸæ²³æ‹±å«ã€‚", getChoices: () => [{ text: "åˆ©ç”¨ä¼¯åŠªåˆ©åŸç†åˆ¶ä½œå–·æ°”èˆ¹ã€æ¶ˆè€—è„‘åŠ›ã€‘", next: 11, effect: { mp: -5 } }, { text: "è®©è‰¾ç³æ–½å±•å†°é­”æ³•å†»ä½æ²³é“ï¼Œç›´æ¥æ¨ªæ¸¡", next: "fail" }] },
        11: { getText: () => "è¿›å…¥åŸå ¡åï¼Œå‘ç°èµ°å»Šå¸ƒæ»¡é›·ç”µé­”æ³•ã€‚", getChoices: () => [{ text: "ä½ å‘ç°è¿™æ˜¯ä¸€ä¸ªé«˜å‹é™ç”µç½‘ï¼Œå‡†å¤‡æ„å»ºæ³•æ‹‰ç¬¬ç¬¼è¿›è¡Œé™ç”µå±è”½ã€æ¶ˆè€—è„‘åŠ›ã€‘", next: 12, effect: { mp: -15 } }, { text: "è®©è‰¾ç³æ–½å±•ç«é­”æ³•ï¼Œæ‘§æ¯é­”æ³•é˜µ", next: "fail" }] },
        12: {
            getText: () => "è«å¾·é›·å‘ç°äº†ä½ ä»¬çš„è¡ŒåŠ¨ï¼Œä»–æ–½å±•äº†æè‡´é˜´å†·çš„æ­»çµé­”æ³•ï¼Œè®©ç¯å¢ƒè¾¾åˆ°äº†ç»å¯¹é›¶åº¦ï¼åˆ†å­å‡ ä¹åœæ­¢çƒ­è¿åŠ¨ã€‚",
            getChoices: () => [
                { text: "ä½ çµæœºä¸€åŠ¨ï¼Œé€šè¿‡ä½¿ç”¨å¤–éª¨éª¼è¿‡è½½æ¨¡å¼æ‘©æ“¦ç”Ÿçƒ­ï¼Œä½†è¿™ä¼šå½»åº•æ‘§æ¯å¤–éª¨éª¼ï¼Œä¸”æ¶ˆè€—å¤§é‡è„‘åŠ›", next: 13, effect: { mp: -10 }, disabled: !state.inventory.includes("è’¸æ±½å¤–éª¨éª¼") },
                { text: "ã€ç¾ç»Šã€‘ä½ æ„å¤–å‘ç°ä½ å¯ä»¥ä¸è‰¾ç³çš„åŠ›é‡å½¢æˆåˆåŠ›å…±æŒ¯ï¼Œä½ ä»¬å¯ä»¥æ¿€å‘ä¸Šå¤ç²¾çµæ—çš„è‡ªç„¶èƒ½é‡", next: 13, effect: { mp: -10 }, disabled: state.romanceLevel === 0 }
            ]
        },
        13: { getText: () => "æš‚æ—¶å‡»é€€è«å¾·é›·åï¼Œä½ ä»¬æ‰¾åˆ°äº†æ ¸å¿ƒé­”æ³•é˜µã€‚ä½ å‘ç°é­”æ³•é˜µæ­£åœ¨å…±æŒ¯ã€‚", getChoices: () => [{ text: "åˆ¶é€ ç›¸æ¶ˆå¹²æ¶‰åŒºã€æ¶ˆè€—è„‘åŠ›ã€‘", next: 14, effect: { mp: -10 } }, { text: "è¯·æ±‚è‰¾ç³ä½¿ç”¨é­”æ³•è½°å‡»", next: "fail" }] },
        14: {
            getText: () => {
                let base = "è«å¾·é›·å€’ä¸‹äº†ã€‚ç©ºé—´æ­£åœ¨åå¡Œã€‚\n";
                if (state.romanceLevel > 0) return base + "<span style='color:#ff79c6;'>è‰¾ç³ç´§ç´§æ¡ä½ä½ çš„æ‰‹ï¼šâ€œè°¢è°¢ä½ ï¼Œè®©æˆ‘æ„Ÿå—åˆ°äº†ä¸å±äºè¿™ä¸ªä¸–ç•Œçš„æ¸©æš–ã€‚ä½†æˆ‘çŸ¥é“ï¼Œä½ æ³¨å®šè¦å›åˆ°å±äºçœŸç†çš„ä¸–ç•Œ...â€</span>";
                return base + "è‰¾ç³æ„Ÿæ¿€åœ°çœ‹ç€ä½ ï¼šâ€œå‹‡è€…ï¼Œä¸–ç•Œå·²ç»å®‰å…¨ï¼Œä½ æ‰“ç®—ï¼Ÿâ€";
            },
            getChoices: () => {
                let options = [{ text: "å›å½’ç°å®ï¼šé‡Šæ”¾å¾®å‹æ ¸èšå˜å›å½’", next: "final_choice" }];
                if (state.romanceLevel === 0) options.push({ text: "ç•™åœ¨å¼‚ä¸–ç•Œï¼šä½œä¸ºè‹±é›„æ´»ä¸‹å»", next: "end_stay" });
                return options;
            }
        },
        "final_choice": {
            getText: () => "ç™½å…‰åå™¬äº†ä¸€åˆ‡ï¼Œä½ æ„Ÿè§‰è‡ªå·±åœ¨æ—¶ç©ºä¸­æ¼‚æµ®...",
            getChoices: () => [{ text: "è¿æ¥æœ€ç»ˆå‘½è¿", next: state.romanceLevel > 0 ? "end_romance" : "end_normal" }]
        },
        "end_stay": { getText: () => "ã€ç»“å±€1ï¼šå¼‚ç•Œè‹±é›„ã€‘ä½ é€‰æ‹©äº†ç•™ä¸‹ã€‚ç”±äºæœªå¼€å¯çœŸç†å›å½’ï¼Œä½ æ²¡æœ‰è·å¾—è–„è·ç³–ã€‚ä½ æˆä¸ºäº†ä¼ è¯´ï¼Œä½†æ— æ³•å¼€å¯ä¸‹ä¸€æ¬¡è½®å›ã€‚", choices: [{ text: "ç»“æŸæ—…ç¨‹", next: "restart_total" }] },
        "end_normal": { getText: () => "ã€ç»“å±€2ï¼šçœŸç†è§‰é†’ã€‘ä½ å›åˆ°äº†è¯¾æ¡Œå‰ï¼Œå£è¢‹é‡Œå¤šäº†ã€è–„è·ç³–ã€‘ã€‚ä½ å¯ä»¥å¼€å¯äºŒå‘¨ç›®è¿æ¥æ›´æ·±çš„ç¾ç»Šã€‚", choices: [{ text: "å¼€å¯äºŒå‘¨ç›®", next: "restart_with_candy" }] },
        "end_romance": { getText: () => "ã€ç»“å±€3ï¼šçœŸç†ä¸ç¾ç»Šã€‘ä½ åœ¨è‰¾ç³çš„æ³ªæ°´ä¸­å›å½’ã€‚æ—…ç¨‹ç»“æŸäº†ï¼Œä½ å·²ä¸å†éœ€è¦è–„è·ç³–ã€‚æ—¶ç©ºä¹‹é—¨ç¼“ç¼“å…³é—­ã€‚", choices: [{ text: "å½»åº•ç»ˆç»“æ—…ç¨‹", next: "restart_total" }] },
        "fail": { getText: () => "è‰¾ç³çš„é­”æ³•å¤±æ§äº†ï¼Œä½ å¤±å»æ„è¯†ã€‚çå¼€çœ¼ï¼Œå‘ç°è‡ªå·±æ­£åœ¨ä¸Šç‰©ç†è¯¾ã€‚", quiz: true }
    };

    function showItemModal(itemName) {
        document.getElementById('new-item-name').innerText = itemName;
        document.getElementById('modal-overlay').style.display = 'block';
        document.getElementById('item-modal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
        document.getElementById('item-modal').style.display = 'none';
    }

    function triggerQuiz(failText) {
        const textEl = document.getElementById('scene-text');
        const btnEl = document.getElementById('choice-buttons');
        const q = physicsQuiz[Math.floor(Math.random() * physicsQuiz.length)];
        textEl.innerHTML = `<span class='fail-text'>${failText}</span><br><div class='quiz-box'><b>âš ï¸ çœŸç†è€ƒéªŒï¼š</b><br>${q.q}</div>`;
        btnEl.innerHTML = '';
        q.a.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.innerText = `${String.fromCharCode(65 + i)}. ${opt}`;
            btn.onclick = () => {
                if (i === q.correct) {
                    alert("å›ç­”æ­£ç¡®ï¼è·å¾—è–„è·ç³–ï¼Œå¼€å¯äºŒå‘¨ç›®ã€‚");
                    localStorage.setItem('gameCleared', 'true');
                    location.reload();
                } else {
                    alert("å›ç­”é”™è¯¯ã€‚ä½ é‡æ–°å å…¥å¹³åº¸çš„ç°å®ã€‚");
                    localStorage.setItem('gameCleared', 'false');
                    location.reload();
                }
            };
            btnEl.appendChild(btn);
        });
    }

    function updateStats() {
        document.getElementById('mp').innerText = state.mp;
        document.getElementById('inventory-display').innerText = state.inventory.join(", ");
        document.getElementById('step').innerText = state.step;
    }

    function renderScene(key) {
        if (key === "restart_with_candy") { localStorage.setItem('gameCleared', 'true'); location.reload(); return; }
        if (key === "restart_total") { localStorage.removeItem('gameCleared'); location.reload(); return; }

        const scene = story[key];
        const textEl = document.getElementById('scene-text');
        const btnEl = document.getElementById('choice-buttons');
        
        if (scene.quiz) { triggerQuiz(scene.getText()); return; }

        textEl.innerHTML = scene.getText();
        btnEl.innerHTML = '';

        if (state.mp <= 0) { triggerQuiz("è„‘åŠ›è€—å°½ã€‚"); return; }

        (scene.getChoices ? scene.getChoices() : (scene.choices || [])).forEach(c => {
            const btn = document.createElement('button');
            btn.innerText = c.text;
            if (c.disabled) btn.disabled = true;
            btn.onclick = () => {
                if (c.effect) {
                    if (c.effect.mp) state.mp += c.effect.mp;
                    if (c.effect.romance) state.romanceLevel = c.effect.romance;
                    if (c.effect.item && !state.inventory.includes(c.effect.item)) {
                        state.inventory.push(c.effect.item);
                        showItemModal(c.effect.item);
                    }
                }
                state.step = typeof c.next === 'number' ? c.next : state.step;
                updateStats();
                renderScene(c.next);
            };
            btnEl.appendChild(btn);
        });
    }

    updateStats();
    renderScene(0);
</script>
</body>
</html>
